name: Update API Documentation

on:
  workflow_run:
    workflows: ["CD"]
    types:
      - completed
    branches:
      - main
      - develop

  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-docs:
    name: Update OpenAPI & Postman Collection
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: serviceportfolio
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Java 24
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install openapi-to-postmanv2
        run: npm install -g openapi-to-postmanv2

      - name: Create temporary private key
        run: |
          mkdir -p /tmp/github-app
          openssl genpkey -algorithm RSA -out /tmp/github-app/private-key.pem -pkeyopt rsa_keygen_bits:2048

      - name: Build and start application
        run: |
          ./gradlew bootJar -x test --no-daemon
          java -jar build/libs/*.jar \
            --server.port=8081 \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/serviceportfolio \
            --spring.datasource.username=test \
            --spring.datasource.password=test \
            --spring.ai.openai.api-key=dummy-key-for-docs \
            --spring.security.oauth2.client.registration.github.client-id=dummy \
            --spring.security.oauth2.client.registration.github.client-secret=dummy \
            --github.app.app-id=0 \
            --github.app.installation-id=0 \
            --github.app.private-key-path=/tmp/github-app/private-key.pem &

          echo "Waiting for application to start..."
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8081/actuator/health > /dev/null 2>&1; then
              echo "Application started successfully"
              break
            fi
            echo "Attempt $i/30..."
            sleep 5
          done

      - name: Fetch OpenAPI spec
        run: |
          HTTP_CODE=$(curl -s -w "%{http_code}" -o openapi.json "http://localhost:8081/v3/api-docs")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Could not fetch OpenAPI spec (HTTP $HTTP_CODE)"
            exit 1
          fi
          cat openapi.json | jq '.' > openapi_formatted.json
          mv openapi_formatted.json openapi.json
          echo "OpenAPI spec fetched: $(wc -c < openapi.json) bytes"

      - name: Generate Postman Collection
        run: |
          openapi2postmanv2 \
            -s openapi.json \
            -o ServicePortfolio_Collection_NEW.postman_collection.json \
            -p \
            -O folderStrategy=Tags,includeAuthInfoInExample=true

          if [ ! -s ServicePortfolio_Collection_NEW.postman_collection.json ]; then
            echo "Error: Could not generate Postman collection"
            exit 1
          fi

      - name: Update collection metadata
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

          jq --arg date "$DATE" --arg branch "$BRANCH" '
            .info.name = "Service Portfolio API - Auto-generated" |
            .info.description = "Collection auto-generated from OpenAPI spec.\n\nDate: \($date)\nBranch: \($branch)\n\nGenerated by GitHub Actions workflow."
          ' ServicePortfolio_Collection_NEW.postman_collection.json > temp.json
          mv temp.json ServicePortfolio_Collection.postman_collection.json
          rm -f ServicePortfolio_Collection_NEW.postman_collection.json

      - name: Check for changes
        id: changes
        run: |
          git add openapi.json ServicePortfolio_Collection.postman_collection.json
          git diff --staged --quiet || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"

          git commit -m "docs: auto-update OpenAPI spec and Postman collection

          - Branch: $BRANCH
          - Generated at build time (no live API dependency)

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git pull --rebase -X theirs
          git push

      - name: Summary
        run: |
          echo "## API Documentation Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI Spec | Updated |" >> $GITHUB_STEP_SUMMARY
          echo "| Postman Collection | Updated |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changed }}" = "true" ]; then
            echo "| Commit | Pushed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Commit | No changes |" >> $GITHUB_STEP_SUMMARY
          fi
