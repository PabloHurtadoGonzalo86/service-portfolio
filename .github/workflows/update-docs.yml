name: Update API Documentation

on:
  workflow_run:
    workflows: ["CD"]
    types:
      - completed
    branches:
      - main
      - develop

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to fetch the spec from'
        required: true
        default: 'develop'
        type: choice
        options:
          - develop
          - production

permissions:
  contents: write

env:
  API_URL_PRODUCTION: https://serviceportfolioapi.pablohgdev.com
  API_URL_DEVELOP: https://serviceportfolioapi.pablohgdev.com

jobs:
  update-docs:
    name: Update OpenAPI & Postman Collection
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install openapi-to-postmanv2
        run: npm install -g openapi-to-postmanv2

      - name: Determine API URL
        id: api-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.event.workflow_run.head_branch }}" = "main" ]; then
            ENV="production"
          else
            ENV="develop"
          fi

          if [ "$ENV" = "production" ]; then
            echo "url=${{ env.API_URL_PRODUCTION }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.API_URL_DEVELOP }}" >> $GITHUB_OUTPUT
          fi
          echo "env=$ENV" >> $GITHUB_OUTPUT

      - name: Wait for API deployment
        run: |
          echo "Waiting 60 seconds for deployment to complete..."
          sleep 60

      - name: Fetch OpenAPI spec
        id: fetch-spec
        run: |
          API_URL="${{ steps.api-url.outputs.url }}"
          echo "Fetching OpenAPI spec from: $API_URL/v3/api-docs"

          for i in 1 2 3; do
            HTTP_CODE=$(curl -s -w "%{http_code}" -o openapi.json "$API_URL/v3/api-docs")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "OpenAPI spec fetched successfully"
              cat openapi.json | jq '.' > openapi_formatted.json
              mv openapi_formatted.json openapi.json
              break
            fi
            echo "Attempt $i failed (HTTP $HTTP_CODE), waiting 30 seconds..."
            sleep 30
          done

          if [ ! -s openapi.json ]; then
            echo "Error: Could not fetch OpenAPI spec"
            exit 1
          fi

          echo "Spec size: $(wc -c < openapi.json) bytes"

      - name: Generate Postman Collection
        run: |
          echo "Generating Postman Collection from OpenAPI spec..."

          openapi2postmanv2 \
            -s openapi.json \
            -o ServicePortfolio_Collection_NEW.postman_collection.json \
            -p \
            -O folderStrategy=Tags,includeAuthInfoInExample=true

          if [ ! -s ServicePortfolio_Collection_NEW.postman_collection.json ]; then
            echo "Error: Could not generate Postman collection"
            exit 1
          fi

          echo "Postman collection generated successfully"

      - name: Update collection metadata
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          ENV="${{ steps.api-url.outputs.env }}"

          jq --arg date "$DATE" --arg branch "$BRANCH" --arg env "$ENV" '
            .info.name = "Service Portfolio API - Auto-generated" |
            .info.description = "Collection auto-generated from OpenAPI spec.\n\nDate: \($date)\nBranch: \($branch)\nEnvironment: \($env)\n\nGenerated by GitHub Actions workflow."
          ' ServicePortfolio_Collection_NEW.postman_collection.json > temp.json
          mv temp.json ServicePortfolio_Collection.postman_collection.json
          rm -f ServicePortfolio_Collection_NEW.postman_collection.json

      - name: Check for changes
        id: changes
        run: |
          git add openapi.json ServicePortfolio_Collection.postman_collection.json
          git diff --staged --quiet || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          ENV="${{ steps.api-url.outputs.env }}"

          git commit -m "docs: auto-update OpenAPI spec and Postman collection

          - Updated from $ENV environment API
          - Branch: $BRANCH
          - Generated by GitHub Actions

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git pull --rebase -X theirs
          git push

      - name: Summary
        run: |
          echo "## API Documentation Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.api-url.outputs.env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.api-url.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI Spec | Updated |" >> $GITHUB_STEP_SUMMARY
          echo "| Postman Collection | Updated |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changed }}" = "true" ]; then
            echo "| Commit | Pushed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Commit | No changes |" >> $GITHUB_STEP_SUMMARY
          fi
