name: Update API Documentation

on:
  workflow_run:
    workflows: ["CD"]
    types:
      - completed
    branches:
      - develop

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to fetch spec from'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: write

env:
  API_URL_DEV: https://serviceportfolioapi-dev.pablohgdev.com
  API_URL_PROD: https://serviceportfolioapi.pablohgdev.com

jobs:
  update-docs:
    name: Update OpenAPI & Postman Collection
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          ref: develop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install openapi-to-postmanv2
        run: npm install -g openapi-to-postmanv2

      - name: Determine API URL
        id: api-url
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="dev"
          fi

          if [ "$ENV" = "prod" ]; then
            echo "url=${{ env.API_URL_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.API_URL_DEV }}" >> $GITHUB_OUTPUT
          fi
          echo "env=$ENV" >> $GITHUB_OUTPUT

      - name: Wait for Keel deployment
        run: |
          echo "Waiting 90 seconds for Keel to detect and deploy the new image..."
          sleep 90

      - name: Fetch OpenAPI spec
        run: |
          API_URL="${{ steps.api-url.outputs.url }}"
          echo "Fetching OpenAPI spec from: $API_URL/v3/api-docs"

          for i in 1 2 3 4 5; do
            HTTP_CODE=$(curl -s -w "%{http_code}" -o openapi.json "$API_URL/v3/api-docs")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "OpenAPI spec fetched successfully"
              cat openapi.json | jq '.' > openapi_formatted.json
              mv openapi_formatted.json openapi.json
              break
            fi
            echo "Attempt $i failed (HTTP $HTTP_CODE), waiting 30 seconds..."
            sleep 30
          done

          if [ ! -s openapi.json ]; then
            echo "Error: Could not fetch OpenAPI spec after 5 attempts"
            exit 1
          fi

          echo "Spec size: $(wc -c < openapi.json) bytes"

      - name: Generate Postman Collection
        run: |
          openapi2postmanv2 \
            -s openapi.json \
            -o ServicePortfolio_Collection_NEW.postman_collection.json \
            -p \
            -O folderStrategy=Tags,includeAuthInfoInExample=true

          if [ ! -s ServicePortfolio_Collection_NEW.postman_collection.json ]; then
            echo "Error: Could not generate Postman collection"
            exit 1
          fi

      - name: Update collection metadata
        run: |
          DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          ENV="${{ steps.api-url.outputs.env }}"

          jq --arg date "$DATE" --arg env "$ENV" '
            .info.name = "Service Portfolio API - Auto-generated" |
            .info.description = "Collection auto-generated from OpenAPI spec.\n\nDate: \($date)\nEnvironment: \($env)\n\nGenerated by GitHub Actions workflow."
          ' ServicePortfolio_Collection_NEW.postman_collection.json > temp.json
          mv temp.json ServicePortfolio_Collection.postman_collection.json
          rm -f ServicePortfolio_Collection_NEW.postman_collection.json

      - name: Check for changes
        id: changes
        run: |
          git add openapi.json ServicePortfolio_Collection.postman_collection.json
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in API docs"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected, will commit"
          fi

      - name: Commit and push to develop and main
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          COMMIT_MSG="docs: auto-update OpenAPI spec and Postman collection

          - Updated from ${{ steps.api-url.outputs.env }} environment API
          - Generated by GitHub Actions

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          # Push to develop
          git commit -m "$COMMIT_MSG"
          git pull --rebase -X theirs
          git push

          # Push same files to main
          COMMIT_SHA=$(git rev-parse HEAD)
          git fetch origin main
          git checkout main
          git pull --rebase -X theirs
          git cherry-pick "$COMMIT_SHA" --strategy-option theirs
          git push
          git checkout develop

      - name: Summary
        run: |
          echo "## API Documentation Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ steps.api-url.outputs.env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.api-url.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI Spec | ${{ steps.changes.outputs.changed == 'true' && 'Updated' || 'No changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Postman Collection | ${{ steps.changes.outputs.changed == 'true' && 'Updated' || 'No changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | ${{ steps.changes.outputs.changed == 'true' && 'Committed to develop and main' || 'Skipped (no changes)' }} |" >> $GITHUB_STEP_SUMMARY
